<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Store Manager - Fast Sync</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #2563eb;
            --staff: #6366f1;
            --admin: #e11d48;
            --bg: #fdfdfd;
            --card: #ffffff;
            --text-main: #1e293b;
            --text-muted: #94a3b8;
            --success: #10b981;
        }

        * { box-sizing: border-box; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background-color: var(--bg); margin: 0; padding: 15px; color: var(--text-main); }
        .container { max-width: 500px; margin: 0 auto; }

        /* Lock Screen */
        #lockScreen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .lock-card { text-align: center; width: 85%; }
        .lock-icon { font-size: 3rem; color: var(--primary); margin-bottom: 20px; }

        /* Header */
        .app-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 0 20px 0; border-bottom: 1px solid #f1f5f9; margin-bottom: 20px;
        }

        /* Admin Panel Card */
        .admin-panel {
            display: none; background: #fff; padding: 20px; border-radius: 20px;
            margin-bottom: 25px; border: 1px solid #e2e8f0;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05);
        }
        .editor-form { display: flex; flex-direction: column; gap: 16px; }
        .admin-mode .admin-panel { display: block; animation: fadeIn 0.3s; }

        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        input {
            width: 100%; padding: 14px; border: 1px solid #e2e8f0; 
            border-radius: 12px; font-size: 16px; background: #f8fafc;
        }
        input:focus { outline: none; border-color: var(--primary); background: white; }

        .btn {
            border: none; padding: 14px; border-radius: 12px; font-weight: 700;
            cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;
            transition: 0.2s;
        }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-admin-toggle { background: #f1f5f9; color: var(--text-main); font-size: 0.8rem; padding: 10px 18px; width: auto; }
        
        /* Item Cards */
        .item-card {
            background: white; padding: 18px; border-radius: 18px;
            margin-bottom: 12px; display: flex; justify-content: space-between;
            align-items: center; border: 1px solid #f1f5f9;
            box-shadow: 0 2px 4px rgba(0,0,0,0.01);
        }
        .item-name { font-weight: 700; font-size: 1.05rem; display: block; }
        .item-qty { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; }
        
        .price-right { text-align: right; }
        .total-price { display: block; font-weight: 800; color: var(--text-main); font-size: 1.1rem; }
        .per-piece { font-size: 0.7rem; color: var(--success); font-weight: 700; background: #ecfdf5; padding: 2px 6px; border-radius: 4px; }

        .admin-actions { display: none; margin-top: 10px; gap: 8px; }
        .admin-mode .admin-actions { display: flex; }
        .btn-icon { background: none; border: none; color: var(--text-muted); font-size: 1rem; padding: 5px; cursor: pointer; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div id="lockScreen">
    <div class="lock-card">
        <div class="lock-icon"><i class="fas fa-store-alt"></i></div>
        <h2 style="margin:0">Store Access</h2>
        <p style="color:var(--text-muted); margin-bottom: 25px;">Enter PIN to view prices</p>
        <input type="password" id="mainPin" placeholder="â€¢â€¢â€¢â€¢" maxlength="4" style="text-align: center; font-size: 24px; letter-spacing: 8px; background: #f1f5f9; border: none;">
        <button class="btn btn-primary" onclick="checkAccess()">
            <i class="fas fa-unlock"></i> Unlock Staff View
        </button>
    </div>
</div>

<div class="container content-area hidden">
    <div class="app-header">
        <div>
            <h2 style="margin:0; font-size: 1.3rem;">Price List</h2>
            <span id="itemCount" style="font-size: 0.8rem; color: var(--text-muted);">Syncing...</span>
        </div>
        <button class="btn btn-admin-toggle" id="adminBtn" onclick="tryAdmin()">
            <i class="fas fa-user-shield"></i> Admin
        </button>
    </div>

    <div class="admin-panel">
        <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <span style="font-weight: 800; font-size: 0.8rem; color: var(--admin);"><i class="fas fa-edit"></i> EDITOR</span>
            <button onclick="exportData()" style="background:none; border:none; color:var(--success); font-weight:bold; cursor:pointer; font-size: 0.75rem;">
                <i class="fas fa-file-export"></i> EXPORT CSV
            </button>
        </div>

         <div class="editor-form">
            <input type="text" id="itemName" placeholder="Product Name">
            <div class="input-row">
                <input type="number" id="itemPrice" placeholder="Total Price">
                <input type="number" id="itemQty" placeholder="Units">
            </div>
            <button class="btn btn-primary" id="saveBtn" onclick="saveItem()">
                <i class="fas fa-check-circle"></i> Update Cloud Inventory
            </button>
        </div>
    </div> 

    <div style="position: sticky; top: 10px; z-index: 10; background: var(--bg); padding-bottom: 10px; display: flex; gap: 8px;">
        <input type="text" id="searchBar" onkeyup="renderList(true)" placeholder="ðŸ” Search product..." style="box-shadow: 0 4px 12px rgba(0,0,0,0.03); border: none;">
        <button onclick="fetchFreshData()" class="btn" style="width: 50px; padding: 0; background: white; border: 1px solid #eee;"><i class="fas fa-sync"></i></button>
    </div>

    <div id="itemList"></div>
</div>

<script>
    // YOUR INTEGRATED SHEET URL
    const SHEET_URL = "https://script.google.com/macros/s/AKfycby3i7LWn5sr18FG3Cw7-JUOfcQEdgJav4DA7Phtl2kSD98KQu9UOzlNUbIgiw9hK0wOzw/exec"; 

    const STAFF_PIN = "1357"; 
    const ADMIN_PIN = "7531"; 
    
    // Load from local memory immediately for instant display
    let items = JSON.parse(localStorage.getItem('store_cache')) || [];
    let isAdmin = false;

    async function checkAccess() {
        const pin = document.getElementById('mainPin').value;
        if (pin.length === 4 && (pin === STAFF_PIN || pin === ADMIN_PIN)) {
            document.getElementById('lockScreen').classList.add('hidden');
            document.querySelector('.content-area').classList.remove('hidden');
            
            renderList(true); // Load cache immediately
            fetchFreshData(); // Get fresh data from cloud in background
        } else { 
            alert("Invalid PIN."); 
            document.getElementById('mainPin').value = "";
        }
    }

    function tryAdmin() {
        if (!isAdmin) {
            const pin = prompt("Admin Security Verification:");
            if (pin === ADMIN_PIN) {
                isAdmin = true;
                document.body.classList.add('admin-mode');
                document.getElementById('adminBtn').innerHTML = '<i class="fas fa-sign-out-alt"></i> Exit Admin';
            }
        } else {
            isAdmin = false;
            document.body.classList.remove('admin-mode');
            document.getElementById('adminBtn').innerHTML = '<i class="fas fa-user-shield"></i> Admin';
        }
    }

    // SPEED: Instant update UI, then sync cloud
    async function saveItem() {
        const name = document.getElementById('itemName').value;
        const price = document.getElementById('itemPrice').value;
        const qty = document.getElementById('itemQty').value || 1;

        if (!name || !price) return;

        const newItem = { name, price: parseFloat(price).toFixed(2), qty: parseInt(qty) };

        // 1. Update UI Instantly (Optimistic UI)
        const idx = items.findIndex(i => i.name === name);
        if (idx > -1) items[idx] = newItem;
        else items.push(newItem);
        
        renderList(true);
        clearForm();

        // 2. Sync with Cloud in background
        fetch(SHEET_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify(newItem)
        }).then(() => {
            localStorage.setItem('store_cache', JSON.stringify(items));
            document.getElementById('itemCount').innerText = `${items.length} items (Synced)`;
        });
    }

    async function deleteItem(name) {
        if(!confirm("Delete from cloud?")) return;

        // 1. Update UI Instantly
        items = items.filter(i => i.name !== name);
        renderList(true);

        // 2. Sync Cloud
        fetch(SHEET_URL, {
            method: 'POST',
            mode: 'no-cors',
            body: JSON.stringify({ action: 'delete', name: name })
        }).then(() => {
            localStorage.setItem('store_cache', JSON.stringify(items));
        });
    }

    async function fetchFreshData() {
        document.getElementById('itemCount').innerText = "Syncing...";
        try {
            const res = await fetch(SHEET_URL);
            items = await res.json();
            localStorage.setItem('store_cache', JSON.stringify(items));
            renderList(false);
        } catch(e) {
            document.getElementById('itemCount').innerText = `${items.length} items (Offline)`;
        }
    }

    function renderList(isFast = false) {
        const q = document.getElementById('searchBar').value.toLowerCase();
        const list = document.getElementById('itemList');
        list.innerHTML = '';

        items.forEach((item, i) => {
            if (item.name.toLowerCase().includes(q)) {
                const perPiece = (item.price / item.qty).toFixed(2);
                list.innerHTML += `
                <div class="item-card">
                    <div>
                        <span class="item-name">${item.name}</span>
                        <span class="item-qty">Pack of ${item.qty} units</span>
                        <div class="admin-actions">
                            <button class="btn-icon" onclick="editItem(${i})"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon" style="color:var(--admin)" onclick="deleteItem('${item.name}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <div class="price-right">
                        <span class="total-price">â‚¹${item.price}</span>
                        <span class="per-piece">â‚¹${perPiece} / pc</span>
                    </div>
                </div>`;
            }
        });
        document.getElementById('itemCount').innerText = `${items.length} items ${isFast ? '(Syncing...)' : '(Synced)'}`;
    }

    function clearForm() {
        document.getElementById('itemName').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemQty').value = '';
        document.getElementById('saveBtn').innerHTML = '<i class="fas fa-check-circle"></i> Update Cloud Inventory';
    }

    function editItem(i) {
        document.getElementById('itemName').value = items[i].name;
        document.getElementById('itemPrice').value = items[i].price;
        document.getElementById('itemQty').value = items[i].qty;
        window.scrollTo({top: 0, behavior: 'smooth'});
    }

    function exportData() {
        let csv = "Item,Total Price,Quantity,Per Piece\n" + 
                  items.map(i => `${i.name},${i.price},${i.qty},${(i.price/i.qty).toFixed(2)}`).join("\n");
        const blob = new Blob([csv], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'store_export.csv';
        a.click();
    }
</script>
</body>
</html>